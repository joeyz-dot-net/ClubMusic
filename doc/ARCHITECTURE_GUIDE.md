# ğŸ—ï¸ åº”ç”¨æ¶æ„æŒ‡å—

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Web æµè§ˆå™¨                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       ä¸»é¡µé¢ (templates/index.html)          â”‚   â”‚
â”‚  â”‚                                             â”‚   â”‚
â”‚  â”‚  HTML å…ƒç´  + CSS æ ·å¼                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â–²                            â”‚
â”‚  DOM äº‹ä»¶ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–º æ›´æ–° DOM         â”‚
â”‚         â”‚              â”‚                           â”‚
â”‚         â”‚              â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  main-modular.js (å‰ç«¯ä¸»å…¥å£)                â”‚   â”‚
â”‚  â”‚                                             â”‚   â”‚
â”‚  â”‚  â”œâ”€ imports modules/*                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ manages app state                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ polls /status every 500ms               â”‚   â”‚
â”‚  â”‚  â””â”€ coordinates all modules                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTP è¯·æ±‚ (JSON)
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPI Web Server                      â”‚
â”‚           (fastapi_app.py - 827 è¡Œ)                â”‚
â”‚                                                     â”‚
â”‚  â”œâ”€ åˆå§‹åŒ–å’Œé…ç½®                                    â”‚
â”‚  â”œâ”€ è·¯ç”±å®šä¹‰ (30+ API ç«¯ç‚¹)                         â”‚
â”‚  â”œâ”€ é™æ€æ–‡ä»¶æœåŠ¡                                    â”‚
â”‚  â””â”€ æ¨¡å—å¯¼å…¥å’Œå…¨å±€å¯¹è±¡                              â”‚
â”‚                                                     â”‚
â”‚  å¯¼å…¥çš„å…¨å±€å¯¹è±¡ï¼š                                   â”‚
â”‚  â”œâ”€ PLAYER = MusicPlayer å®ä¾‹                      â”‚
â”‚  â”œâ”€ PLAYLISTS_MANAGER = Playlists å®ä¾‹             â”‚
â”‚  â”œâ”€ RANK_MANAGER = HitRank å®ä¾‹                    â”‚
â”‚  â””â”€ CURRENT_PLAYLIST = å½“å‰æ’­æ”¾åˆ—è¡¨                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ è°ƒç”¨æ•°æ®æ¨¡å‹
                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                         â”‚              â”‚
          â–¼                         â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ MusicPlayer â”‚         â”‚  Playlists   â”‚  â”‚ HitRank  â”‚
   â”‚(player.py) â”‚         â”‚(playlists.py)â”‚  â”‚(rank.py) â”‚
   â”‚  1500+ è¡Œ   â”‚         â”‚              â”‚  â”‚          â”‚
   â”‚             â”‚         â”œâ”€ å¤šæ­Œå•ç®¡ç†  â”‚  â”œâ”€ æ’è¡Œç»Ÿè®¡â”‚
   â”‚ èŒè´£ï¼š      â”‚         â”œâ”€ CRUD æ“ä½œ   â”‚  â”œâ”€ æ—¶é—´æ®µ  â”‚
   â”‚ âœ“ æ’­æ”¾æ§åˆ¶ â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ âœ“ MPV é€šä¿¡ â”‚
   â”‚ âœ“ çŠ¶æ€ç®¡ç† â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ IPC å‘½ä»¤ï¼ˆJSONï¼‰
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    mpv.exe (Windows)        â”‚
   â”‚  (éŸ³é¢‘æ’­æ”¾åç«¯å¼•æ“)          â”‚
   â”‚                             â”‚
   â”‚  âœ“ æ’­æ”¾éŸ³é¢‘æ–‡ä»¶             â”‚
   â”‚  âœ“ æµåª’ä½“è§£ç                â”‚
   â”‚  âœ“ éŸ³é‡å’Œè¿›åº¦æ§åˆ¶           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®æŒä¹…åŒ–ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         JSON æ•°æ®æ–‡ä»¶                â”‚
â”‚                                      â”‚
â”‚ â”œâ”€ playback_history.json  (æ’­æ”¾å†å²) â”‚
â”‚ â”œâ”€ playlist.json          (å½“å‰é˜Ÿåˆ—) â”‚
â”‚ â””â”€ playlists.json         (æ‰€æœ‰æ­Œå•) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµå‘è¯¦è§£

### 1. åº”ç”¨å¯åŠ¨æµç¨‹

```
ç”¨æˆ·åŒå‡» å¯åŠ¨éŸ³ä¹æ’­æ”¾å™¨.bat
  â”‚
  â–¼
run_fastapi.py
  â”œâ”€ è¯»å– settings.ini
  â”œâ”€ å¯¼å…¥ fastapi_app
  â”‚
  â””â”€ fastapi_app.py æ¨¡å—åˆå§‹åŒ–
      â”œâ”€ ä» models/ å¯¼å…¥æ‰€æœ‰ç±»
      â”‚   â”œâ”€ from models.song import LocalSong, StreamSong
      â”‚   â”œâ”€ from models.player import MusicPlayer
      â”‚   â”œâ”€ from models.playlist import CurrentPlaylist, PlayHistory
      â”‚   â”œâ”€ from models.playlists import Playlists
      â”‚   â””â”€ from models.rank import HitRank
      â”‚
      â”œâ”€ åˆ›å»ºå…¨å±€å¯¹è±¡
      â”‚   â”œâ”€ PLAYER = MusicPlayer.initialize()
      â”‚   â”‚   â”œâ”€ è¯»å–é…ç½®
      â”‚   â”‚   â”œâ”€ å¯åŠ¨ mpv.exe è¿›ç¨‹
      â”‚   â”‚   â”œâ”€ åˆ›å»º IPC ç®¡é“ \\.\pipe\mpv-pipe
      â”‚   â”‚   â”œâ”€ åŠ è½½ playback_history.json
      â”‚   â”‚   â””â”€ åŠ è½½ playlist.json
      â”‚   â”‚
      â”‚   â”œâ”€ PLAYLISTS_MANAGER = Playlists()
      â”‚   â”‚   â””â”€ åŠ è½½ playlists.json
      â”‚   â”‚
      â”‚   â””â”€ RANK_MANAGER = HitRank()
      â”‚       â””â”€ åˆå§‹åŒ–æ’è¡Œæ¦œ
      â”‚
      â”œâ”€ æ³¨å†Œæ‰€æœ‰ API è·¯ç”±ï¼ˆ30+ ä¸ªï¼‰
      â”œâ”€ é…ç½® CORS å’Œé™æ€æ–‡ä»¶æœåŠ¡
      â”‚
      â””â”€ å¯åŠ¨ Uvicorn æœåŠ¡å™¨ (http://0.0.0.0:80)
```

### 2. ç”¨æˆ·è¯·æ±‚ Web ç•Œé¢

```
æµè§ˆå™¨è®¿é—® http://localhost/
  â”‚
  â–¼
GET / è¯·æ±‚
  â”‚
  â–¼
fastapi_app.py: @app.get("/")
  â”œâ”€ è¯»å– templates/index.html
  â”œâ”€ è¿”å› HTML å†…å®¹
  â”‚
  â””â”€ æµè§ˆå™¨æ¸²æŸ“é¡µé¢
      â”œâ”€ åŠ è½½ HTML ç»“æ„
      â”œâ”€ åº”ç”¨ CSS æ ·å¼
      â”‚
      â””â”€ æ‰§è¡Œ JavaScript
          â”œâ”€ <script type="module" src="/static/js/main-modular.js">
          â”‚
          â”œâ”€ main-modular.js æ‰§è¡Œ
          â”‚   â”œâ”€ import modules/*ï¼ˆ7 ä¸ªæ¨¡å—ï¼‰
          â”‚   â”œâ”€ åˆå§‹åŒ– MusicPlayerApp
          â”‚   â”œâ”€ è·å– DOM å…ƒç´ 
          â”‚   â”œâ”€ ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
          â”‚   â”‚
          â”‚   â””â”€ å¯åŠ¨è½®è¯¢
          â”‚       â””â”€ æ¯ 500ms è°ƒç”¨ /status
```

### 3. ç”¨æˆ·æ’­æ”¾æ­Œæ›²

```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®
  â”‚
  â–¼
HTML ä¸­çš„ <button id="playBtn">
  â”‚
  â–¼
main-modular.js æ•è· click äº‹ä»¶
  â”‚
  â”œâ”€ ç¡®å®šè¦æ’­æ”¾çš„æ­Œæ›²
â”‚   â”œâ”€ ä» playlist.js è·å–å½“å‰æ­Œæ›²
â”‚   â””â”€ ä»æœ¬åœ°æœç´¢ç»“æœè·å–
â”‚
  â–¼
api.js.play(songData)
  â”‚
  â”œâ”€ æ„å»º FormData: {path, title, ...}
  â”‚
  â–¼
fetch('POST /play', FormData)
  â”‚
  â–¼
fastapi_app.py: @app.post("/play")
  â”‚
  â”œâ”€ è§£æè¯·æ±‚æ•°æ®
  â”œâ”€ åˆ›å»º Song å¯¹è±¡
  â”‚
  â–¼
PLAYER.play(song)
  â”‚
  â”œâ”€ è½¬æ¢ Song å¯¹è±¡ä¸º URL
  â”‚
  â–¼
PLAYER.mpv_command(['loadfile', url])
  â”‚
  â”œâ”€ æ„å»º JSON å‘½ä»¤
  â”œâ”€ å†™å…¥ IPC ç®¡é“
  â”‚
  â–¼
mpv.exe æ¥æ”¶å‘½ä»¤
  â”‚
  â”œâ”€ åŠ è½½å’Œè§£ç éŸ³é¢‘
  â”‚
  â–¼
éŸ³é¢‘è¾“å‡º (æ‰¬å£°å™¨)
  â”‚
  â–¼
[å¹¶è¡Œ] åå°çº¿ç¨‹ç›‘æ§è¿›åº¦
  â”‚
  â”œâ”€ æ¯ 100ms è¯»å– mpv_get('time-pos')
  â”œâ”€ è®°å½•åˆ°å†…å­˜
  â”‚
  â””â”€ [å¹¶è¡Œ] main-modular.js è½®è¯¢ /status
      â”‚
      â”œâ”€ æ¯ 500ms è°ƒç”¨ GET /status
      â”‚
      â–¼
      fastapi_app.py: @app.get("/status")
      â”‚
      â”œâ”€ æ”¶é›†å½“å‰çŠ¶æ€
      â”‚   â”œâ”€ PLAYER.current_meta (æ­Œæ›²ä¿¡æ¯)
      â”‚   â”œâ”€ mpv_get('time-pos') (å½“å‰æ—¶é—´)
      â”‚   â”œâ”€ mpv_get('duration') (æ€»æ—¶é•¿)
      â”‚   â””â”€ mpv_get('paused') (æš‚åœçŠ¶æ€)
      â”‚
      â–¼
      è¿”å› JSON: {status, data: {mpv: {...}}}
      â”‚
      â–¼
      main-modular.js æ¥æ”¶å“åº”
      â”‚
      â”œâ”€ è§£æ JSON
      â”‚
      â–¼
      updatePlayerUI()
      â”‚
      â”œâ”€ æ›´æ–°è¿›åº¦æ¡
      â”œâ”€ æ›´æ–°æ—¶é—´æ˜¾ç¤º
      â”œâ”€ æ›´æ–°æ ‡é¢˜å’Œå°é¢
      â”‚
      â–¼
      DOM æ›´æ–°
      â”‚
      â–¼
      ç”¨æˆ·çœ‹åˆ°æ’­æ”¾è¿›åº¦æ›´æ–°
```

### 4. ç”¨æˆ·æ·»åŠ æ­Œæ›²åˆ°é˜Ÿåˆ—

```
ç”¨æˆ·ç‚¹å‡»æ­Œæ›²ï¼ˆæ¥è‡ªæœ¬åœ°æˆ–æœç´¢ç»“æœï¼‰
  â”‚
  â–¼
main-modular.js æ•è·äº‹ä»¶
  â”‚
  â”œâ”€ æ£€æŸ¥æ˜¯å¦å·²åœ¨é˜Ÿåˆ—ä¸­ï¼ˆdeduplicationï¼‰
  â”‚   â””â”€ playlistUrlSet.has(url)
  â”‚
  â–¼
å¦‚æœä¸é‡å¤ï¼Œè°ƒç”¨ api.js.addToPlaylist(song)
  â”‚
  â”œâ”€ æ„å»º FormData
  â”‚
  â–¼
fetch('POST /playlist_add', FormData)
  â”‚
  â–¼
fastapi_app.py: @app.post("/playlist_add")
  â”‚
  â”œâ”€ ä» CURRENT_PLAYLIST è·å–å½“å‰é˜Ÿåˆ—
  â”‚
  â–¼
CURRENT_PLAYLIST.add(song)
  â”‚   (models/playlist.py çš„ CurrentPlaylist ç±»)
  â”‚
  â”œâ”€ æ·»åŠ åˆ°å†…å­˜åˆ—è¡¨
  â”œâ”€ è°ƒç”¨ CURRENT_PLAYLIST.save()
  â”‚
  â–¼
ä¿å­˜åˆ° playlist.json
  â”‚
  â–¼
è¿”å›æ›´æ–°åçš„æ’­æ”¾åˆ—è¡¨ JSON
  â”‚
  â–¼
main-modular.js æ¥æ”¶å“åº”
  â”‚
  â”œâ”€ è°ƒç”¨ renderPlaylist()
  â”‚
  â–¼
æ›´æ–°é¡µé¢ä¸Šçš„æ’­æ”¾åˆ—è¡¨æ˜¾ç¤º
  â”‚
  â–¼
ç”¨æˆ·çœ‹åˆ°æ–°æ­Œæ›²å·²æ·»åŠ 
```

---

## ğŸ—ï¸ æ¨¡å—æ¶æ„

### å‰ç«¯æ¨¡å—å…³ç³»

```
main-modular.js (314 è¡Œ)
â”‚
â”œâ”€ import { api } from './modules/api.js'
â”‚   â””â”€ æ‰€æœ‰ HTTP è¯·æ±‚éƒ½é€šè¿‡è¿™é‡Œ
â”‚
â”œâ”€ import { player } from './modules/player.js'
â”‚   â”œâ”€ æ’­æ”¾/æš‚åœ/next/prev
â”‚   â”œâ”€ çŠ¶æ€è½®è¯¢
â”‚   â””â”€ è¿›åº¦æ§åˆ¶
â”‚
â”œâ”€ import { playlistManager } from './modules/playlist.js'
â”‚   â”œâ”€ åŠ è½½é˜Ÿåˆ—
â”‚   â”œâ”€ æ·»åŠ /åˆ é™¤æ­Œæ›²
â”‚   â””â”€ é‡æ–°æ’åº
â”‚
â”œâ”€ import { volumeControl } from './modules/volume.js'
â”‚   â”œâ”€ è®¾ç½®éŸ³é‡
â”‚   â””â”€ è·å–éŸ³é‡
â”‚
â”œâ”€ import { searchManager } from './modules/search.js'
â”‚   â”œâ”€ æœ¬åœ°æœç´¢
â”‚   â”œâ”€ YouTube æœç´¢
â”‚   â””â”€ æ’­æ”¾åˆ—è¡¨æå–
â”‚
â”œâ”€ import { Toast, loading } from './modules/ui.js'
â”‚   â”œâ”€ æ¶ˆæ¯æç¤º
â”‚   â”œâ”€ åŠ è½½åŠ¨ç”»
â”‚   â””â”€ æ—¶é—´æ ¼å¼åŒ–
â”‚
â””â”€ import { isMobile } from './modules/utils.js'
    â””â”€ å·¥å…·å‡½æ•°
```

### åç«¯æ¨¡å—å…³ç³»

```
fastapi_app.py (827 è¡Œ)
â”‚
â””â”€ imports:
    â”‚
    â”œâ”€ from models.song import LocalSong, StreamSong
    â”‚   â”œâ”€ LocalSong
    â”‚   â”‚   â””â”€ æœ¬åœ°æ–‡ä»¶æ’­æ”¾
    â”‚   â”‚       â”œâ”€ éªŒè¯æ–‡ä»¶æ ¼å¼
    â”‚   â”‚       â””â”€ ç”Ÿæˆç¼©ç•¥å›¾
    â”‚   â”‚
    â”‚   â””â”€ StreamSong
    â”‚       â””â”€ YouTube æµåª’ä½“æ’­æ”¾
    â”‚           â”œâ”€ yt-dlp æœç´¢
    â”‚           â”œâ”€ æå–æ’­æ”¾ URL
    â”‚           â””â”€ è·å–æ ‡é¢˜å’Œç¼©ç•¥å›¾
    â”‚
    â”œâ”€ from models.player import MusicPlayer
    â”‚   â”œâ”€ MusicPlayer.initialize()
    â”‚   â”‚   â”œâ”€ å¯åŠ¨ mpv.exe
    â”‚   â”‚   â”œâ”€ å»ºç«‹ IPC ç®¡é“
    â”‚   â”‚   â””â”€ åŠ è½½å†å²å’Œé˜Ÿåˆ—
    â”‚   â”‚
    â”‚   â”œâ”€ PLAYER.play(song)
    â”‚   â”œâ”€ PLAYER.pause()
    â”‚   â”œâ”€ PLAYER.next()
    â”‚   â”œâ”€ PLAYER.prev()
    â”‚   â””â”€ PLAYER.mpv_command()/mpv_get()
    â”‚
    â”œâ”€ from models.playlist import CurrentPlaylist, PlayHistory
    â”‚   â”œâ”€ CURRENT_PLAYLIST.add()
    â”‚   â”œâ”€ CURRENT_PLAYLIST.remove()
    â”‚   â”œâ”€ CURRENT_PLAYLIST.reorder()
    â”‚   â””â”€ PlayHistory (å¾ªç¯ç¼“å†²)
    â”‚
    â”œâ”€ from models.playlists import Playlists
    â”‚   â”œâ”€ PLAYLISTS_MANAGER.create()
    â”‚   â”œâ”€ PLAYLISTS_MANAGER.add_song()
    â”‚   â”œâ”€ PLAYLISTS_MANAGER.delete()
    â”‚   â””â”€ PLAYLISTS_MANAGER.save()
    â”‚
    â””â”€ from models.rank import HitRank
        â”œâ”€ RANK_MANAGER.increment()
        â”œâ”€ RANK_MANAGER.get_top()
        â””â”€ RANK_MANAGER.get_by_period()
```

---

## ğŸ’¾ æ•°æ®å­˜å‚¨ç»“æ„

### playback_history.json

```json
[
  {
    "url": "path/to/song.mp3",
    "title": "æ­Œæ›²æ ‡é¢˜",
    "type": "local",
    "duration": 180,
    "thumbnail_url": "...",
    "play_count": 5,
    "last_played": 1704067200000
  },
  ...
]
```

**æœ€å¤§é•¿åº¦**ï¼š50 æ¡è®°å½•ï¼ˆå¾ªç¯ç¼“å†²ï¼‰

### playlist.json

```json
{
  "songs": [
    {
      "url": "path/to/song1.mp3",
      "title": "æ­Œæ›²1",
      "type": "local",
      "duration": 180,
      "thumbnail_url": "..."
    },
    ...
  ],
  "current_index": 0
}
```

### playlists.json

```json
{
  "default": {
    "id": "default",
    "name": "é»˜è®¤æ­Œå•",
    "songs": [...],
    "created_time": 1704067200000,
    "is_default": true,
    "is_deletable": false
  },
  "1704067200000": {
    "id": "1704067200000",
    "name": "æˆ‘çš„æ­Œå•",
    "songs": [...],
    "created_time": 1704067200000,
    "is_default": false,
    "is_deletable": true
  }
}
```

---

## ğŸ”Œ API åˆ†å±‚

### ç¬¬ 1 å±‚ï¼šHTTP ç«¯ç‚¹ (fastapi_app.py)

```python
@app.post("/play")
async def play(request: Request):
    # 1. è§£æè¯·æ±‚
    # 2. éªŒè¯æ•°æ®
    # 3. è°ƒç”¨æ•°æ®æ¨¡å‹
    # 4. è¿”å› JSON å“åº”
```

**èŒè´£**ï¼š
- å¤„ç† HTTP è¯·æ±‚/å“åº”
- æ•°æ®éªŒè¯
- é”™è¯¯å¤„ç†

### ç¬¬ 2 å±‚ï¼šä¸šåŠ¡é€»è¾‘ (models/)

```python
class MusicPlayer:
    def play(self, song):
        # 1. è½¬æ¢æ•°æ®æ ¼å¼
        # 2. è°ƒç”¨ MPV
        # 3. æ›´æ–°å†…éƒ¨çŠ¶æ€
        # ä¸æ¶‰åŠ HTTP
```

**èŒè´£**ï¼š
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- æ•°æ®æ¨¡å‹ç®¡ç†
- çŠ¶æ€ç»´æŠ¤

### ç¬¬ 3 å±‚ï¼šå¤–éƒ¨ç³»ç»Ÿ (MPV, æ–‡ä»¶ç³»ç»Ÿ, yt-dlp)

```python
def mpv_command(cmd_list):
    # 1. åºåˆ—åŒ–ä¸º JSON
    # 2. é€šè¿‡ IPC å‘é€
    # 3. ç­‰å¾…å“åº”
```

**èŒè´£**ï¼š
- å®é™…çš„éŸ³é¢‘æ’­æ”¾
- åª’ä½“è§£ç 
- å¤–éƒ¨é›†æˆ

---

## âš™ï¸ é…ç½®ç®¡ç†

### é…ç½®è¯»å–æµç¨‹

```
run_fastapi.py
  â”‚
  â”œâ”€ configparser.ConfigParser()
  â”‚
  â”œâ”€ read('settings.ini')
  â”‚   â”‚
  â”‚   â””â”€ [app] éƒ¨åˆ†
  â”‚       â”œâ”€ music_dir: éŸ³ä¹åº“ä½ç½®
  â”‚       â”œâ”€ allowed_extensions: æ”¯æŒçš„æ ¼å¼
  â”‚       â”œâ”€ server_host: æœåŠ¡å™¨åœ°å€
  â”‚       â”œâ”€ server_port: æœåŠ¡å™¨ç«¯å£
  â”‚       â”œâ”€ debug: è°ƒè¯•æ¨¡å¼
  â”‚       â””â”€ mpv_cmd: MPV å¯åŠ¨å‘½ä»¤
  â”‚
  â””â”€ ä¼ é€’ç»™ uvicorn.run()
```

### é…ç½®åº”ç”¨åˆ°ä»£ç 

```
settings.ini
  â”‚
  â”œâ”€ server_host â†’ uvicorn.run(host=...)
  â”œâ”€ server_port â†’ uvicorn.run(port=...)
  â”œâ”€ music_dir â†’ models/player.py â†’ æ„å»ºæ–‡ä»¶æ ‘
  â””â”€ mpv_cmd â†’ models/player.py â†’ subprocess.Popen()
```

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### /debug/mpv ç«¯ç‚¹

```
GET /debug/mpv
  â”‚
  â””â”€ è¿”å›ï¼š
     â”œâ”€ MPV è¿›ç¨‹çŠ¶æ€
     â”œâ”€ IPC ç®¡é“çŠ¶æ€
     â”œâ”€ å½“å‰æ’­æ”¾åˆ—è¡¨é•¿åº¦
     â””â”€ æœ€åä¸€æ¬¡é”™è¯¯ä¿¡æ¯
```

**ç”¨é€”**ï¼šè¯Šæ–­ MPV è¿æ¥é—®é¢˜

### æµè§ˆå™¨å¼€å‘è€…å·¥å…·

```
F12 â†’ Console
  â”‚
  â”œâ”€ window.modules  (æŸ¥çœ‹æ‰€æœ‰åŠ è½½çš„æ¨¡å—)
  â”œâ”€ window._playlistUrlSet  (æŸ¥çœ‹å»é‡é›†åˆ)
  â””â”€ fetch('/status')  (æ‰‹åŠ¨æµ‹è¯• API)
```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å‰ç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç° | æ•ˆæœ |
|-------|------|------|
| ä»£ç åˆ†å‰² | 7 ä¸ªç‹¬ç«‹æ¨¡å— | æŒ‰éœ€åŠ è½½ |
| å»é‡ | playlistUrlSet | é˜²æ­¢é‡å¤æ·»åŠ  |
| èŠ‚æµ | çŠ¶æ€è½®è¯¢ 500ms | å‡å°‘ç½‘ç»œè¯·æ±‚ |
| äº‹ä»¶ä»£ç† | äº‹ä»¶å§”æ‰˜ | å‡å°‘äº‹ä»¶ç›‘å¬å™¨ |

### åç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç° | æ•ˆæœ |
|-------|------|------|
| å¼‚æ­¥ I/O | async/await | å¹¶å‘å¤„ç†è¯·æ±‚ |
| ç¼“å­˜ | å†…å­˜ä¸­çš„å…¨å±€å¯¹è±¡ | é¿å…é‡å¤åˆå§‹åŒ– |
| æ¶ˆæ¯é˜Ÿåˆ— | åå°çº¿ç¨‹ | ä¸é˜»å¡ä¸»çº¿ç¨‹ |

### æ•°æ®åº“ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç° | æ•ˆæœ |
|-------|------|------|
| æœ¬åœ°å­˜å‚¨ | JSON æ–‡ä»¶ | å¿«é€Ÿè®¿é—® |
| å¾ªç¯ç¼“å†² | PlayHistory (max 50) | é™åˆ¶å†…å­˜ |

---

## ğŸš€ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°æ¨¡å—

1. **åˆ›å»ºæ–‡ä»¶** `static/js/modules/my-feature.js`
   ```javascript
   export const myFeature = {
       init() { },
       doSomething() { }
   };
   ```

2. **å¯¼å…¥åˆ° main-modular.js**
   ```javascript
   import { myFeature } from './modules/my-feature.js';
   ```

3. **åœ¨åˆå§‹åŒ–ä¸­ä½¿ç”¨**
   ```javascript
   myFeature.init();
   ```

### æ·»åŠ æ–° API ç«¯ç‚¹

1. **åœ¨ fastapi_app.py ä¸­**
   ```python
   @app.post("/my_endpoint")
   async def my_endpoint(request: Request):
       return {"status": "OK", "data": {...}}
   ```

2. **åœ¨ api.js ä¸­**
   ```javascript
   export async function myEndpoint(params) {
       return fetch('/my_endpoint', {...});
   }
   ```

3. **åœ¨æ¨¡å—ä¸­ä½¿ç”¨**
   ```javascript
   const response = await api.myEndpoint(params);
   ```

---

## â“ FAQ

**Q: ä¸ºä»€ä¹ˆåˆ†ç¦»åç«¯å’Œå‰ç«¯ï¼Ÿ**
A: ä¾¿äºå¼€å‘ã€æµ‹è¯•å’Œç»´æŠ¤ï¼Œå‰ç«¯å¯ä»¥ç‹¬ç«‹ç¼–å†™å’Œéƒ¨ç½²

**Q: ä¸ºä»€ä¹ˆä½¿ç”¨è½®è¯¢è€Œä¸æ˜¯ WebSocketï¼Ÿ**
A: ç®€åŒ–æ¶æ„ï¼Œé¿å…çŠ¶æ€ç®¡ç†çš„å¤æ‚æ€§ï¼Œ500ms å»¶è¿Ÿå¯¹ç”¨æˆ·ä½“éªŒè¶³å¤Ÿ

**Q: å¦‚ä½•æ·»åŠ æ•°æ®åº“ï¼Ÿ**
A: æ›¿æ¢ `models/` ä¸­çš„ JSON æ–‡ä»¶æ“ä½œä¸º ORMï¼ˆå¦‚ SQLAlchemyï¼‰

**Q: å¦‚ä½•éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ**
A: å‚è§ [doc/BUILD_GUIDE.md](BUILD_GUIDE.md)
